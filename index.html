<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o de Empr√©stimos - Relat√≥rio Mensal</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #271137 0%, #130323 100%); min-height: 100vh; padding: 30px; }
        .container { max-width: 1400px; margin: 0 auto; background: #F8F9FA; border-radius: 15px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .header { background: #050207; border-radius: 10px 10px 0 0; padding: 25px; margin-bottom: 30px; }
        .header h1 { color: white; font-size: 28px; font-weight: 600; text-align: center; letter-spacing: 1px; }
        .header .subtitle { color: rgba(255,255,255,0.85); text-align: center; font-size: 16px; font-style: italic; margin-top: 8px; }
        .header .date { color: rgba(255,255,255,0.7); text-align: center; font-size: 12px; margin-top: 12px; }
        .upload-section { border: 3px dashed #000000; border-radius: 15px; padding: 50px; text-align: center; background: white; cursor: pointer; transition: all 0.3s; margin-bottom: 30px; }
        .upload-section:hover { background: #F5EEF8; border-color: #0d0218; }
        .upload-section.dragover { background: #E8F5E9; border-color: #28A745; }
        .upload-icon { font-size: 64px; color: #1f0d2d; margin-bottom: 15px; }
        .upload-text { font-size: 20px; color: #333; margin-bottom: 10px; }
        .upload-hint { font-size: 14px; color: #666; }
        .report-container { display: none; }
        .report-container.visible { display: block; }
        .card-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-left: 6px solid; transition: transform 0.3s; }
        .card:hover { transform: translateY(-5px); }
        .card-title { font-size: 14px; color: #666; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .card-value { font-size: 28px; font-weight: bold; color: #13071b; }
        .section-title { font-size: 20px; font-weight: 600; color: #140324; margin: 30px 0 20px; padding-bottom: 10px; border-bottom: 3px solid #150a1e; }
        .table-container { overflow-x: auto; margin-bottom: 30px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { background: white; color: #150426; font-weight: 600; padding: 15px 10px; border-bottom: 3px solid #12071a; white-space: nowrap; }
        td { padding: 12px 10px; border-bottom: 1px solid #E0E0E0; }
        tr:nth-child(even) { background-color: #FAFAFA; }
        tr:hover { background-color: #F5EEF8; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        .font-bold { font-weight: 600; }
        .status-active { color: #1d4225; font-weight: 600; }
        .status-danger { color: #ba4032; font-weight: 600; }
        .status-do-not-lend { color: #670101; font-weight: 600; }
        .status-agreement { color: #a06602; font-weight: 600; }
        .status-quitado { color: #115c23; font-weight: 600; }
        .status-orange { color: #ff8c00; font-weight: 600; } /* Novo estilo para laranja */
        .totals-row { background: #F5EEF8 !important; font-weight: 600; border-top: 2px solid #333; border-bottom: 2px solid #333; }
        .toolbar { display: flex; justify-content: flex-end; gap: 15px; margin-bottom: 20px; }
        .btn { padding: 12px 25px; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
        .btn-primary { background: #170a21; color: white; }
        .btn-primary:hover { background: #10031d; transform: translateY(-2px); }
        .btn-success { background: #28A745; color: white; }
        .btn-success:hover { background: #1E7E34; transform: translateY(-2px); }
        .loading { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 20px 40px; border-radius: 10px; z-index: 1000; }
        .loading.visible { display: block; }
        .error-message { background: #FFE6E6; border: 1px solid #ff1900; border-radius: 8px; padding: 15px; color: #ff1900; margin-bottom: 20px; display: none; }
        .error-message.visible { display: block; }
        .footer { margin-top: 40px; padding: 20px; text-align: center; color: #666; font-size: 12px; border-top: 1px solid #E0E0E0; }
        .zoom-control { position: fixed; bottom: 20px; right: 20px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); display: flex; gap: 10px; z-index: 100; }
        @media print { body { background: white; } .container { box-shadow: none; } .upload-section, .toolbar, .zoom-control { display: none; } }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <h3>Processando dados...</h3>
        <p style="margin-top: 10px;">Detectando status por m√∫ltiplos crit√©rios...</p>
    </div>

    <div class="container">
        <div class="header">
            <h1>Relat√≥rio Financeiro</h1>
            <div class="subtitle">Sistema de Gest√£o de Empr√©stimos (v1.1 - Detec√ß√£o Aprimorada)</div>
            <div class="date" id="currentDate"></div>
        </div>

        <div class="upload-section" id="uploadArea">
            <div class="upload-icon">üìä</div>
            <div class="upload-text">Arraste sua planilha Excel ou clique para selecionar</div>
            <div class="upload-hint">Detecta ACORDO e LARANJA automaticamente por texto e l√≥gica</div>
            <input type="file" id="fileInput" accept=".xlsx,.xlsm" style="display: none;">
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="report-container" id="reportContainer">
            <div class="toolbar">
                <button class="btn btn-primary" onclick="window.print()"><span>üìÑ</span> PDF / Imprimir</button>
                <button class="btn btn-primary" onclick="resetSystem()"><span>üîÑ</span> Nova Planilha</button>
            </div>
            <div id="reportContent"></div>
            <div class="footer">Confidencial - Uso Interno<br>Gerado em: <span id="generatedDateTime"></span></div>
        </div>
    </div>

    <div class="zoom-control">
        <button onclick="zoomOut()">‚àí</button>
        <span id="zoomLevel">85%</span>
        <button onclick="zoomIn()">+</button>
    </div>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script>
        const SHEET_NAME_DATA = "Planilha Atual";
        const CUTOFF_DAY = 12;
        const COL = { 
            STATUS: 0,    // Coluna A - Status
            NOME: 2,      // Coluna C - Nome
            DATA: 4,      // Coluna E - Data
            VALOR: 5,     // Coluna F - Valor
            EMPRESTADO: 6, // Coluna G - Emprestado
            PREVISTO: 9,  // Coluna J - Previsto
            PAGO: 10,     // Coluna K - Pago
            OBS: 16       // Coluna Q - Observa√ß√µes
        };

        let monthlyData = {};
        let currentZoom = 85;
        let stats = { totalLinhas: 0, linhasProcessadas: 0, linhasIgnoradas: 0 };

        document.addEventListener('DOMContentLoaded', () => {
            updateDateTime();
            setupEventListeners();
            setInterval(updateDateTime, 1000);
            document.getElementById('zoomLevel').textContent = currentZoom + '%';
        });

        function setupEventListeners() {
            const area = document.getElementById('uploadArea');
            const input = document.getElementById('fileInput');
            
            area.onclick = () => input.click();
            area.ondragover = (e) => { e.preventDefault(); area.classList.add('dragover'); };
            area.ondragleave = () => area.classList.remove('dragover');
            area.ondrop = (e) => { 
                e.preventDefault(); 
                area.classList.remove('dragover'); 
                if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); 
            };
            input.onchange = (e) => { if(e.target.files.length) handleFile(e.target.files[0]); };
        }

        function handleFile(file) {
            showLoading();
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    if (!workbook.SheetNames.includes(SHEET_NAME_DATA)) {
                        throw new Error(`Aba '${SHEET_NAME_DATA}' n√£o encontrada.`);
                    }
                    
                    const worksheet = workbook.Sheets[SHEET_NAME_DATA];
                    const data = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                    
                    processData(data);
                    
                    if (Object.keys(monthlyData).length > 0) {
                        document.getElementById('reportContainer').classList.add('visible');
                        generateReport();
                    } else {
                        showError('Nenhum dado v√°lido encontrado para processar.');
                    }
                } catch (err) { 
                    showError(err.message); 
                }
                hideLoading();
            };
            reader.readAsArrayBuffer(file);
        }

        function processData(rows) {
            monthlyData = {};
            stats = { totalLinhas: rows.length - 1, linhasProcessadas: 0, linhasIgnoradas: 0 };
            const hoje = new Date();
            
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                
                // Pular linhas vazias
                if (!row || row.length < 5) { 
                    stats.linhasIgnoradas++; 
                    continue; 
                }

                // Verificar se tem dados m√≠nimos
                if (!row[COL.DATA] && !row[COL.EMPRESTADO]) { 
                    stats.linhasIgnoradas++; 
                    continue; 
                }

                const dataOriginal = parseExcelDate(row[COL.DATA]);
                const periodo = extractPeriodo(dataOriginal);
                
                if (periodo === 'Sem Data') { 
                    stats.linhasIgnoradas++; 
                    continue; 
                }

                // Extrair valores
                const valorEmprestado = getNum(row[COL.EMPRESTADO] || row[COL.VALOR]);
                const valorPrevisto = getNum(row[COL.PREVISTO]);
                const valorPago = getNum(row[COL.PAGO]);
                
                // Determinar status com m√∫ltiplos crit√©rios
                const status = determinarStatus(row, dataOriginal, hoje, valorPrevisto, valorPago);

                // Inicializar per√≠odo se necess√°rio
                if (!monthlyData[periodo]) {
                    monthlyData[periodo] = {
                        totalEmprestado: 0, totalPrevisto: 0, totalPago: 0, 
                        totalLucro: 0, totalSaldoAberto: 0,
                        emprestadoAte12: 0, previstoAte12: 0, pagoAte12: 0,
                        status: { 
                            'ATIVO': 0, 
                            'N√ÉO EMPRESTAR': 0, 
                            'QUITADO': 0, 
                            'AMARELADO': 0,  // Laranja/Amarelo
                            'COBRAR': 0,      // Vermelho
                            'CLIENTE EM ACORDO': 0 
                        }
                    };
                }

                const p = monthlyData[periodo];
                
                // Acumular valores
                p.totalEmprestado += valorEmprestado;
                p.totalPrevisto += valorPrevisto;
                p.totalPago += valorPago;
                p.totalLucro += (valorPago > valorPrevisto ? valorPago - valorPrevisto : 0);
                p.totalSaldoAberto += (valorPrevisto > valorPago ? valorPrevisto - valorPago : 0);

                // Valores at√© dia 12
                if (dataOriginal && dataOriginal.getDate() <= CUTOFF_DAY) {
                    p.emprestadoAte12 += valorEmprestado;
                    p.previstoAte12 += valorPrevisto;
                    p.pagoAte12 += valorPago;
                }

                // Incrementar contador de status
                if (p.status[status] !== undefined) {
                    p.status[status]++;
                } else {
                    console.warn('Status desconhecido:', status);
                    p.status['ATIVO']++; // Fallback
                }
                
                stats.linhasProcessadas++;
            }
            
            console.log('Processamento conclu√≠do:', stats);
        }

        function determinarStatus(linha, dataRef, hoje, valorPrevisto, valorPago) {
            // Coletar textos de todas as colunas relevantes
            const obs = String(linha[COL.OBS] || '').toUpperCase().trim();
            const stTxt = String(linha[COL.STATUS] || '').toUpperCase().trim();
            const nome = String(linha[COL.NOME] || '').toUpperCase().trim();
            
            // Concatenar tudo para busca de palavras-chave
            const fullTxt = `${nome} ${obs} ${stTxt}`;
            
            // 1. PRIORIDADE M√ÅXIMA: ACORDO (detectado por texto)
            if (fullTxt.includes('ACORDO') || 
                fullTxt.includes('ACORDADO') || 
                fullTxt.includes('ACERTADO') ||
                (obs.includes('ACORDO') && !obs.includes('SEM ACORDO'))) {
                console.log('ACORDO detectado em:', nome);
                return 'CLIENTE EM ACORDO';
            }
            
            // 2. N√ÉO EMPRESTAR (detectado por texto)
            if (fullTxt.includes('N√ÉO EMPRESTAR') || 
                fullTxt.includes('NAO EMPRESTAR') ||
                fullTxt.includes('N√ÉO') || 
                fullTxt.includes('NAO')) {
                return 'N√ÉO EMPRESTAR';
            }
            
            // 3. QUITADO (detectado por texto ou valores)
            if (fullTxt.includes('QUITADO') || fullTxt.includes('QUITADA')) {
                return 'QUITADO';
            }
            
            // 4. Verificar quita√ß√£o por valores
            if (valorPago >= valorPrevisto && valorPrevisto > 0) {
                return 'QUITADO';
            }

            // 5. AMARELADO/LARANJA (detectado por texto ou atraso)
            if (fullTxt.includes('AMAREL') || 
                fullTxt.includes('LARANJA') ||
                fullTxt.includes('ATEN√á√ÉO') ||
                fullTxt.includes('ATENCAO')) {
                return 'AMARELADO';
            }

            // 6. COBRAR (detectado por texto)
            if (fullTxt.includes('COBRAR') || 
                fullTxt.includes('VENCEU') ||
                fullTxt.includes('ATRASADO')) {
                return 'COBRAR';
            }

            // 7. L√≥gica de atraso autom√°tica (simulando formata√ß√£o condicional)
            if (dataRef && valorPrevisto > valorPago) {
                const diffTempo = hoje - dataRef;
                const diffDias = Math.ceil(diffTempo / (1000 * 60 * 60 * 24));

                if (diffDias > 30) {
                    return 'COBRAR';      // Vermelho (atraso > 30 dias)
                }
                if (diffDias > 5) {
                    return 'AMARELADO';   // Laranja (atraso entre 6-30 dias)
                }
            }

            // 8. Padr√£o: ATIVO
            return 'ATIVO';
        }

        function parseExcelDate(val) {
            if (!val) return null;
            
            try {
                // Se j√° √© Date
                if (val instanceof Date) return val;
                
                // Se √© n√∫mero Excel (ex: 45012)
                if (typeof val === 'number') {
                    const d = XLSX.SSF.parse_date_code(val);
                    if (d) return new Date(d.y, d.m - 1, d.d);
                }
                
                // Se √© string com formato brasileiro
                if (typeof val === 'string') {
                    if (val.includes('/')) {
                        const p = val.split('/');
                        if (p.length === 3) {
                            return new Date(p[2], p[1] - 1, p[0]);
                        }
                    }
                    // Tentar convers√£o direta
                    const d = new Date(val);
                    if (!isNaN(d.getTime())) return d;
                }
            } catch (e) {
                console.warn('Erro ao parsear data:', val, e);
            }
            
            return null;
        }

        function extractPeriodo(date) {
            if (!date) return 'Sem Data';
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        }

        function getNum(v) {
            if (v === null || v === undefined || v === '') return 0;
            if (typeof v === 'number') return v;
            
            try {
                // Remover R$, espa√ßos, pontos de milhar e converter v√≠rgula decimal
                let cleaned = String(v).replace(/[R$\s]/g, '')
                                     .replace(/\./g, '')
                                     .replace(',', '.');
                let n = parseFloat(cleaned);
                return isNaN(n) ? 0 : n;
            } catch (e) {
                return 0;
            }
        }

        function formatBRL(v) { 
            return 'R$ ' + v.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.'); 
        }

        function generateReport() {
            const periodos = Object.keys(monthlyData).sort();
            
            // Calcular totais
            let totaisStatus = {
                'ATIVO': 0, 'N√ÉO EMPRESTAR': 0, 'QUITADO': 0, 
                'AMARELADO': 0, 'COBRAR': 0, 'CLIENTE EM ACORDO': 0
            };
            
            let totalEmprestado = 0, totalPago = 0, totalSaldo = 0, totalLucro = 0;
            
            periodos.forEach(pKey => {
                const p = monthlyData[pKey];
                totalEmprestado += p.totalEmprestado;
                totalPago += p.totalPago;
                totalSaldo += p.totalSaldoAberto;
                totalLucro += p.totalLucro;
                
                Object.keys(p.status).forEach(s => {
                    totaisStatus[s] += p.status[s];
                });
            });

            // Cards de resumo
            let html = `<div class="card-grid">
                <div class="card" style="border-left-color: #7030A0;">
                    <div class="card-title">Total Emprestado</div>
                    <div class="card-value">${formatBRL(totalEmprestado)}</div>
                </div>
                <div class="card" style="border-left-color: #28A745;">
                    <div class="card-title">Total Pago</div>
                    <div class="card-value">${formatBRL(totalPago)}</div>
                </div>
                <div class="card" style="border-left-color: #E74C3C;">
                    <div class="card-title">Saldo em Aberto</div>
                    <div class="card-value">${formatBRL(totalSaldo)}</div>
                </div>
                <div class="card" style="border-left-color: #28A745;">
                    <div class="card-title">Lucro/Excedente</div>
                    <div class="card-value">${formatBRL(totalLucro)}</div>
                </div>
            </div>`;

            // Tabela de Status
            html += `<div class="section-title">AN√ÅLISE DE STATUS POR PER√çODO</div>
                     <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th class="text-left">PER√çODO</th>
                                    <th class="text-right">ATIVO</th>
                                    <th class="text-right">N√ÉO EMPRESTAR</th>
                                    <th class="text-right">QUITADO</th>
                                    <th class="text-right">AMARELADO/LARANJA</th>
                                    <th class="text-right">COBRAR</th>
                                    <th class="text-right">CLIENTE EM ACORDO</th>
                                    <th class="text-right">TOTAL</th>
                                </tr>
                            </thead>
                            <tbody>`;

            periodos.forEach(pKey => {
                const p = monthlyData[pKey];
                const total = Object.values(p.status).reduce((a, b) => a + b, 0);
                const [ano, mes] = pKey.split('-');
                const meses = ['JAN', 'FEV', 'MAR', 'ABR', 'MAI', 'JUN', 'JUL', 'AGO', 'SET', 'OUT', 'NOV', 'DEZ'];
                const nomeMes = meses[parseInt(mes) - 1];
                
                html += `<tr>
                    <td class="text-left font-bold">${nomeMes} ${ano}</td>
                    <td class="text-right status-active">${p.status['ATIVO']}</td>
                    <td class="text-right status-do-not-lend">${p.status['N√ÉO EMPRESTAR']}</td>
                    <td class="text-right status-quitado">${p.status['QUITADO']}</td>
                    <td class="text-right status-orange">${p.status['AMARELADO']}</td>
                    <td class="text-right status-danger">${p.status['COBRAR']}</td>
                    <td class="text-right status-agreement">${p.status['CLIENTE EM ACORDO']}</td>
                    <td class="text-right font-bold">${total}</td>
                </tr>`;
            });

            // Linha de totais
            const totalGeral = Object.values(totaisStatus).reduce((a, b) => a + b, 0);
            html += `<tr class="totals-row">
                <td class="text-left font-bold">TOTAIS</td>
                <td class="text-right font-bold">${totaisStatus['ATIVO']}</td>
                <td class="text-right font-bold">${totaisStatus['N√ÉO EMPRESTAR']}</td>
                <td class="text-right font-bold">${totaisStatus['QUITADO']}</td>
                <td class="text-right font-bold">${totaisStatus['AMARELADO']}</td>
                <td class="text-right font-bold">${totaisStatus['COBRAR']}</td>
                <td class="text-right font-bold">${totaisStatus['CLIENTE EM ACORDO']}</td>
                <td class="text-right font-bold">${totalGeral}</td>
            </tr>`;

            html += `</tbody></table></div>`;

            // Estat√≠sticas de processamento
            if (stats.linhasProcessadas > 0) {
                html += `<div style="margin-top: 20px; padding: 15px; background: #F5EEF8; border-radius: 8px; font-size: 11px;">
                    <span style="color: #7030A0; font-weight: 600;">üìä Estat√≠sticas:</span>
                    Total de linhas: ${stats.totalLinhas} | 
                    Processadas: ${stats.linhasProcessadas} | 
                    Ignoradas: ${stats.linhasIgnoradas} |
                    <span style="color: #28A745;">‚úì Detec√ß√£o aprimorada (ACORDO/LARANJA por texto)</span>
                </div>`;
            }

            document.getElementById('reportContent').innerHTML = html;
        }

        function updateDateTime() {
            const d = new Date().toLocaleString('pt-BR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('currentDate').textContent = 'Gerado em ' + d;
            document.getElementById('generatedDateTime').textContent = d;
        }

        function showError(m) { 
            const e = document.getElementById('errorMessage'); 
            e.textContent = m; 
            e.classList.add('visible');
            setTimeout(() => e.classList.remove('visible'), 5000);
        }
        
        function showLoading() { document.getElementById('loading').classList.add('visible'); }
        function hideLoading() { document.getElementById('loading').classList.remove('visible'); }
        function resetSystem() { location.reload(); }
        
        function zoomIn() { 
            if (currentZoom < 150) {
                currentZoom += 5; 
                document.body.style.zoom = currentZoom + '%'; 
                document.getElementById('zoomLevel').textContent = currentZoom + '%';
            }
        }
        
        function zoomOut() { 
            if (currentZoom > 50) {
                currentZoom -= 5; 
                document.body.style.zoom = currentZoom + '%'; 
                document.getElementById('zoomLevel').textContent = currentZoom + '%';
            }
        }
    </script>
</body>
</html>